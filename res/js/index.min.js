!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i,o=t();for(i in o)("object"==typeof exports?exports:e)[i]=o[i]}}(this,function(){return o={},s.m=i={"../../res/js/index.js":
/*!*****************************************************************!*\
  !*** D:/project/tl-open-source/tl-rtc-file-git/res/js/index.js ***!
  \*****************************************************************/
/*! no static exports found */function(e,t){axios.get(window.prefix+"/api/comm/initData",{}).then(e=>{let t=e.data;new Vue({el:"#fileApp",data:function(){let e=null;return io&&(e=io(t.wsHost)),{socket:e,config:t.rtcConfig,options:t.options,isJoined:!1,showReceiveFile:!1,showSendFile:!1,showReceiveTxt:!1,showLogs:!1,numSendFile:150,numReceiveFile:150,numReceiveTxt:150,numLogs:150,currentMenu:1,logsHeight:0,allManCount:0,isTxtMode:!1,txtEditId:0,isRealContentMode:!1,nickName:"",socketId:0,roomId:"10086",recoderId:0,fileReader:null,rtcConns:{},remoteMap:{},chunkSize:262144,offset:0,fileName:null,hasSending:!1,allSended:!1,currentReceiveSize:0,chooseFile:null,sendFileList:[],sendTxtList:[],receiveFileList:[],receiveTxtList:[],logs:[]}},computed:{createDisabled:function(){return this.isJoined||this.fileName},exsitDisabled:function(){return!this.isJoined},sending:function(){return this.hasSending},uploadDisabled:function(){return!this.fileName||this.allSended},showSendFileList:function(){return this.sendFileList&&5<this.sendFileList.length},noOthersInRoom:function(){return 0===Object.keys(this.remoteMap).length}},watch:{hasSending:function(e,t){},allManCount:function(e,t){},currentMenu:function(e,t){},allSended:function(e,t){},fileName:function(e,t){if(this.chooseFile=this.$refs["self-file"].files[0],this.chooseFile&&this.socketId){this.$refs.sendProgress.max=this.chooseFile.size,this.socket.emit("message",{emitType:"sendFileInfo",name:this.chooseFile.name,type:this.chooseFile.type,size:this.chooseFile.size,room:this.roomId,from:this.socketId,recoderId:this.recoderId}),this.allSended=!1;let t=[];for(var i in this.remoteMap)this.setRemoteInfo(i,{status:0}),t.push(i);if(this.socketId){let e="";for(var o in 0<t.length&&(e+="发送给房间的 "+t[0]+" ...等"+t.length+"人"),this.remoteMap)this.sendFileList.push({id:o,name:this.chooseFile.name,size:this.chooseFile.size,type:this.chooseFile.type,process:0,done:!1,toIdStr:e,start:0,cost:0})}}},currentReceiveSize:function(e,t){this.currentReceiveSize=e},remoteMap:{handler:function(e,t){},deep:!0,immediate:!0},receiveFileList:{handler:function(e,t){},deep:!0,immediate:!0},receiveTxtList:{handler:function(e,t){},deep:!0,immediate:!0},sendFileList:{handler:function(e,t){},deep:!0,immediate:!0}},methods:{shareUrl:function(){document.querySelector("#shareUrl").setAttribute("data-clipboard-text",window.location.origin+"#r="+this.roomId),new ClipboardJS("#shareUrl").on("success",function(e){e.clearSelection(),window.layer&&layer.msg("复制房间链接成功!")})},copyTxt:function(e,t){document.querySelector("#"+e).setAttribute("data-clipboard-text",t),new ClipboardJS("#"+e).on("success",function(e){e.clearSelection(),window.layer&&layer.msg("复制内容成功!")})},handlerRoomHistory:function(){let t=this;var e=window.location.hash||"";e&&e.includes("#")&&((e=e.split("r="))&&1<e.length&&(this.roomId=(e[1]+"").replace(/\s*/g,"").substr(0,14),window.layer&&(layer.confirm("进入房间"+this.roomId,e=>{window.location.hash="",layer.close(e),t.createRoom()},e=>{t.roomId="",window.location.hash="",layer.close(e)}),this.addPopup("你通过分享加入了房间号为 "+this.roomId),this.logs.push("你通过分享加入了房间号为 "+this.roomId))))},refleshRoom:function(){this.createDisabled||(this.roomId=parseInt(1e5*Math.random()),this.addPopup("你刷新了房间号, 当前房间号为 "+this.roomId),this.logs.push("你刷新了房间号, 当前房间号为 "+this.roomId),$("#refresh").removeClass("layui-anim-rotate").addClass("layui-anim-rotate"))},genNickName:function(){return function(t){let i="";for(let e=0;e<t;e++){var o="";s=19968,n=40869,o=Math.floor(Math.random()*(s-n)+n).toString(16),i+=(o=(o="\\u"+(o=o)).replace(/\\/g,"%"),o=(o=unescape(o)).replace(/%/g,"\\"))}var s,n;return i}(4)},addPopup:function(e){window.Bus.$emit("addPopup",e)},cleanPopup:function(){window.Bus.$emit("popupMap")},clickChooseFile:function(){this.$refs["self-file"].click(),this.createDisabled||(this.addPopup("请先创建/加入房间后，再选择文件"),this.logs.push("请先创建/加入房间后，再选择文件")),this.noOthersInRoom&&(this.addPopup("请用户方都加入房间后，再选择文件"),this.logs.push("请用户方都加入房间后，再选择文件"))},sendTxt:function(){var e;this.isRealContentMode?1e3<(e=layedit.getContent(this.txtEditId)).length?window.layer&&layer.msg("富文本文字内容过长，长度最多1w单词!"):(this.socket.emit("message",{emitType:"sendTxt",content:encodeURIComponent(e),room:this.roomId,from:this.socketId,recoderId:this.recoderId}),window.layer&&layer.msg("富文本内容发送完毕")):1e3<(e=layedit.getText(this.txtEditId)).length?window.layer&&layer.msg("文字内容过长，最多1000单词!"):(this.socket.emit("message",{emitType:"sendTxt",content:encodeURIComponent(e),room:this.roomId,from:this.socketId,recoderId:this.recoderId}),window.layer&&layer.msg("内容发送完毕"))},clickHome:function(e=!0){this.currentMenu=1;let t=document.body;var i=document.querySelector(".menu__border");let o=this.$refs.btnHome;var s=o.getBoundingClientRect();t.style.backgroundColor=o.style.getPropertyValue("--bgColorBody"),document.querySelector(".chooseFileName").style.backgroundColor=o.style.getPropertyValue("--bgColorBody"),function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(s,i),e&&this.clickSendFile()},clickReceive:function(e=!0){this.currentMenu=2;let t=document.body;var i=document.querySelector(".menu__border");let o=this.$refs.btnReceive;var s=o.getBoundingClientRect();t.style.backgroundColor=o.style.getPropertyValue("--bgColorBody"),document.querySelector(".chooseFileName").style.backgroundColor=o.style.getPropertyValue("--bgColorBody"),function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(s,i),e&&this.clickReceiveFile()},clickTxt:function(e=!0){this.currentMenu=3;let t=document.body;var i=document.querySelector(".menu__border");let o=this.$refs.btnTxt;var s=o.getBoundingClientRect();t.style.backgroundColor=o.style.getPropertyValue("--bgColorBody"),function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(s,i),e&&this.clickReceiveTxt()},getFileSizeStr:function(e){let t=(e/1048576).toString();e=t.split(".")[0];let i="";return t.split(".")[1]&&(i=t.split(".")[1].substr(0,3)),e+"."+i+"M"},clickReceiveFile:function(){this.showReceiveFile=!this.showReceiveFile,this.showReceiveFile?this.numReceiveFile=50:this.numReceiveFile=150},clickReceiveTxt:function(e=!0){e&&(this.isTxtMode=!this.isTxtMode,window.layui&&window.layedit&&(this.txtEditId=window.layedit.build("txt",{tool:["strong","italic","underline","del","|","left","center","right","face"]}))),this.showReceiveTxt=!this.showReceiveTxt,this.showReceiveTxt?this.numReceiveTxt=50:this.numReceiveTxt=150},clickSendFile:function(){this.showSendFile=!this.showSendFile,this.showSendFile?this.numSendFile=50:this.numSendFile=150},clickLogs:function(){this.showLogs=!this.showLogs,this.showLogs?this.numLogs=50:this.numLogs=150},createRoom:function(){this.roomId=this.roomId.toString().replace(/\s*/g,""),null!==this.roomId&&void 0!==this.roomId&&""!==this.roomId?null==this.fileName?this.roomId&&(15<this.roomId.toString().length?alert("房间号太长啦"):(this.socket.emit("createAndJoin",{room:this.roomId}),this.isJoined=!0,this.addPopup("你进入了房间"+this.roomId),this.logs.push("你进入了房间"+this.roomId))):alert("请先加入房间再选文件"):alert("请先填写房间号")},exitRoom:function(){for(var t in this.roomId&&this.socket.emit("exit",{from:this.socketId,room:this.roomId,recoderId:this.recoderId}),this.rtcConns){let e=this.rtcConns[t];e.close(),e=null}window.location.reload()},getRtcConnect:function(e){return this.rtcConns[e]},createRtcConnect:function(o){if(void 0!==o){let t=this,i=new RTCPeerConnection(this.config);return i.onicecandidate=e=>{t.iceCandidate(i,o,e)},this.rtcConns[o]=i,this.remoteMap[o]||Vue.set(this.remoteMap,o,{id:o}),this.initSendDataChannel(o),i.onremovestream=e=>{t.removeStream(i,o,e)},i}},getOrCreateRtcConnect:function(e){let t=this.getRtcConnect(e);return void 0===t&&(t=this.createRtcConnect(e)),t},initSendDataChannel:function(t){let i=this,e=this.rtcConns[t].createDataChannel("sendDataChannel");e.binaryType="arraybuffer",e.addEventListener("open",()=>{"open"===e.readyState&&i.logs.push("建立连接 : channel open")}),e.addEventListener("close",()=>{"close"===e.readyState&&i.logs.push("连接关闭 : channel close")}),e.addEventListener("error",e=>{i.handlerSendChannelError(e)}),this.rtcConns[t].addEventListener("datachannel",e=>{i.initReceiveDataChannel(e,t)}),this.setRemoteInfo(t,{sendChannel:e})},handlerSendChannelError:function(e){console.error(e.error),this.logs.push("连接断开 : "+e)},submitChooseFile:function(){this.initSendData()},initSendData:function(){let t=this;if(null==this.chooseFile||null==this.chooseFile)return this.addPopup("请先选择文件"),void this.logs.push("请先选择文件");this.fileReader=new FileReader,this.fileReader.addEventListener("error",e=>{t.logs.push("读取文件错误 : "+e)}),this.fileReader.addEventListener("abort",e=>{t.logs.push("读取文件中断 : "+e)}),this.fileReader.addEventListener("load",this.sendData),this.readSlice(0)},sendData:function(t){let i="",e=!1;for(var o in this.remoteMap)1===(this.remoteMap[o].status||0)&&(e=!0,i=o);if(e)this.allSended=!1;else{let e=!0;for(var s in this.remoteMap){s=this.remoteMap[s].status||0;0!==s&&1!==s||(this.allSended=!1,e=!1)}if(e)return this.allSended=!0,void(this.hasSending=!1);for(var n in this.remoteMap)0===(this.remoteMap[n].status||0)&&(i=n);this.setRemoteInfo(i,{status:1})}if(""!=i){this.hasSending=!0;var r=this.remoteMap[i];if(1===(r.status||0)){let e=r.sendChannel;e&&"open"===e.readyState&&(0===this.offset&&(this.addPopup("正在发送给"+i.substr(0,4)+",0%。"),this.logs.push("正在发送给"+i.substr(0,4)+",0%。"),this.updateSendProcess(i,{start:Date.now()})),e.send(t.target.result),this.offset+=t.target.result.byteLength,t=this.offset,this.updateSendProcess(i,{process:parseInt(t/this.chooseFile.size*100)}),this.offset===this.chooseFile.size&&(console.log(i+"发送完毕"),this.shaking("iamtsm",0,4),this.addPopup("正在发送给"+i.substr(0,4)+",100%。"),this.logs.push("正在发送给"+i.substr(0,4)+",100%。"),this.socket.emit("message",{emitType:"sendDone",room:this.roomId,from:this.socketId,size:this.chooseFile.size,name:this.chooseFile.name,type:this.chooseFile.type,to:i}),this.updateSendProcess(i,{done:!0}),this.offset=0,this.setRemoteInfo(i,{status:2}),this.submitChooseFile()))}}},readSlice:function(e){e=this.chooseFile.slice(this.offset,e+this.chunkSize);this.fileReader.readAsArrayBuffer(e)},receivedAck:function(e,t){this.socket.emit("message",{emitType:"receivedAck",room:this.roomId,from:this.socketId,offset:t,chunkSize:this.chunkSize,to:e})},initReceiveDataChannel:function(t,i){if(i&&t&&this.getRemoteInfo(i)){let e=t.channel;e.binaryType="arraybuffer",e.onmessage=e=>{this.receiveData(e,i)},e.onopen=()=>{e.readyState},e.onclose=()=>{e.readyState},this.setRemoteInfo(i,{receiveChannel:e})}},receiveData:function(t,i){if(t&&i){var o=this.getRemoteInfo(i),s=o.receiveFiles||{},n=s.name,r=s.size,s=s.type;let e=o.receiveBuffer||new Array;o=o.receivedSize||0;0===o&&this.updateReceiveProcess(i,{start:Date.now()}),e.push(t.data),o+=t.data.byteLength,this.$refs.receiveProgress.value=o,this.setRemoteInfo(i,{receiveBuffer:e,receivedSize:o}),this.currentReceiveSize+=t.data.byteLength,this.receivedAck(i,o),this.updateReceiveProcess(i,{process:parseInt(o/r*100)}),o===r&&(console.log("接收完毕"),this.shaking("iamtsm",0,4),this.logs.push("接收完毕..."),this.$refs.receiveProgress.value=0,this.addPopup("文件[ "+n+" ]接收完毕，可点击右下角查看。"),this.updateReceiveProcess(i,{style:"color: #ff5722;text-decoration: underline;",href:URL.createObjectURL(new Blob(e),{type:s}),done:!0}),this.setRemoteInfo(i,{receiveBuffer:new Array,receivedSize:0}),this.currentReceiveSize=0)}},closeDataChannels:function(){for(var i in this.remoteMap){var o=i.id;let e=i.sendChannel,t=i.receiveChannel;o&&e&&t&&(e.close(),t.close())}},setRemoteInfo(e,t){var i;e&&t&&((i=this.remoteMap[e])&&(Object.assign(i,t),Vue.set(this.remoteMap,e,i)))},updateReceiveProcess:function(t,i){for(let e=0;e<this.receiveFileList.length;e++){var o=this.receiveFileList[e];o.id!==t||o.done||(i.cost=parseInt((Date.now()-o.start)/1e3),Object.assign(this.receiveFileList[e],i))}},updateSendProcess:function(t,i){for(let e=0;e<this.sendFileList.length;e++){var o=this.sendFileList[e];o.id!==t||o.done||(i.cost=parseInt((Date.now()-o.start)/1e3),Object.assign(this.sendFileList[e],i))}},getRemoteInfo(e){if(e)return this.remoteMap[e]},removeStream:function(e,t,i){this.getOrCreateRtcConnect(t).close,delete this.rtcConns[t],delete this.remoteMap[t]},iceCandidate:function(e,t,i){null!=i.candidate&&(i={from:this.socketId,to:t,room:this.roomId,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,sdp:i.candidate.candidate},this.socket.emit("candidate",i))},offerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("offer",i)},offerFailed:function(e,t,i){this.logs.push("offer失败,"+i)},answerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("answer",i)},answerFailed:function(e,t,i){this.logs.push("answer失败,"+i)},addIceCandidateSuccess:function(e){this.logs.push("addIceCandidateSuccess成功,"+e)},addIceCandidateFailed:function(e){this.logs.push("addIceCandidate失败,"+e)},socketListener:function(){let s=this;this.socket.emit("count",{}),this.socket.on("created",async function(o){s.logs.push("创建房间,"+JSON.stringify(o)),s.socketId=o.id,s.roomId=o.room,s.recoderId=o.recoderId;for(let e=0;e<o.peers.length;e++){let t=o.peers[e].id,i=s.getOrCreateRtcConnect(t);i.createOffer(s.options).then(e=>{s.offerSuccess(i,t,e)},e=>{s.offerFailed(i,t,e)})}s.touchResize()}),this.socket.on("joined",function(e){s.logs.push("加入房间,"+JSON.stringify(e)),s.recoderId=e.recoderId,s.getOrCreateRtcConnect(e.from),s.addPopup(e.id+"加入了房间。"),s.touchResize()}),this.socket.on("offer",function(t){s.logs.push("offer,"+JSON.stringify(t));let i=s.getOrCreateRtcConnect(t.from);var e={type:"offer",sdp:t.sdp};i.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{}),i.createAnswer(s.options).then(e=>{s.answerSuccess(i,t.from,e)}).catch(e=>{s.answerFailed(i,t.from,e)})}),this.socket.on("answer",function(e){s.logs.push("answer,"+JSON.stringify(e));let t=s.getOrCreateRtcConnect(e.from);e={type:"answer",sdp:e.sdp};t.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{})}),this.socket.on("candidate",function(e){s.logs.push("candidate,"+JSON.stringify(e));let t=s.getOrCreateRtcConnect(e.from);e=new RTCIceCandidate({candidate:e.sdp,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex});t.addIceCandidate(e).then(e=>{s.addIceCandidateSuccess(e)}).catch(e=>{s.addIceCandidateFailed(e)})}),this.socket.on("exit",function(e){void 0!==s.rtcConns[e.from]&&(s.addPopup(e.from+"退出了房间。"),s.logs.push("退出房间,"+JSON.stringify(e)),s.getOrCreateRtcConnect(e.from).close,delete s.rtcConns[e.from],Vue.delete(s.remoteMap,e.from),s.touchResize())}),this.socket.on("sendFileInfo",function(e){var t=e.from;s.setRemoteInfo(t,{receiveFiles:e}),s.addPopup(e.from+"选择了文件 [ "+e.name+" ]，即将发送。"),s.logs.push(e.from+"选择了文件 [ "+e.name+" ]，即将发送。"),s.$refs.receiveProgress.max=e.size,s.receiveFileList.push({id:t,href:"",name:e.name,type:e.type,size:e.size,process:0,done:!1,start:0,cost:0})}),this.socket.on("receivedAck",function(e){e.to===s.socketId&&s.offset<s.chooseFile.size&&s.readSlice(s.offset)}),this.socket.on("sendTxt",function(e){var t=e.from;s.addPopup(e.from+"发送了文字 [ "+e.content.substr(0,10)+" ]"),s.logs.push(e.from+"发送了文字 [ "+e.content.substr(0,10)+" ]"),s.receiveTxtList.push({id:t,content:decodeURIComponent(e.content),time:(new Date).toLocaleString(),c_id:"txt_"+s.receiveTxtList.length,process:0,done:!1,start:0,cost:0})}),this.socket.on("count",function(e){s.allManCount=e.mc})},initCss:function(e){e&&(1===this.currentMenu?this.clickHome(!1):2===this.currentMenu?this.clickRoom(!1):3===this.currentMenu&&this.clickTxt(!1),this.reCaculateSwiperSize(),this.logsHeight=document.documentElement.clientHeight-55)},loadJS:function(e,t){var i=document.createElement("script"),o=t||function(){};i.type="text/javascript",i.readyState?i.onreadystatechange=function(){"loaded"!=i.readyState&&"complete"!=i.readyState||(i.onreadystatechange=null,o())}:i.onload=function(){o()},i.src=e,document.getElementsByTagName("head")[0].appendChild(i)},reCaculateSwiperSize:function(){var e=document.body.clientWidth,e=parseInt(e/100)-1;window.swiper&&(window.swiper.params.slidesPerView=e)},touchResize:function(){let t=this;setTimeout(()=>{var e=new Event("resize");window.dispatchEvent(e),t.reCaculateSwiperSize()},100)},shaking:function(e,t,i){let o=["maringTop","marginLeft"],s=0;window.shakingId=setInterval(function(){document.getElementById(e).style[o[s%2]]=s++%4<2?t+"px":i+"px",15<s&&(clearInterval(window.shakingId),s=0)},32)},debounce:function(e,t){return function(){window.debounce_timeout_id&&window.clearTimeout(window.debounce_timeout_id),window.debounce_timeout_id=setTimeout(e,t)}}},created:function(){let e=this;window.location.hash&&window.location.hash.includes("debug")&&this.loadJS("/static/js/vconsole.min.js",function(){e.loadJS("/static/js/vconsole.js",function(){console.log("load vconsole success")})}),setTimeout(()=>{e.handlerRoomHistory()},200)},mounted:function(){this.$nextTick(()=>{this.logs.push("socket 初始化中..."),this.socketListener(),this.logs.push("socket 初始化成功")}),this.clickHome(!1),window.onresize=this.initCss},destroyed:function(){}})})}},s.c=o,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)s.d(i,o,function(e){return t[e]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s="../../res/js/index.js");function s(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}var i,o});