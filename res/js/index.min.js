!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i,o=t();for(i in o)("object"==typeof exports?exports:e)[i]=o[i]}}(this,function(){return o={},n.m=i={"../../res/js/index.js":
/*!*****************************************************************!*\
  !*** D:/project/tl-open-source/tl-rtc-file-git/res/js/index.js ***!
  \*****************************************************************/
/*! no static exports found */function(e,t){axios.get(window.prefix+"/api/comm/initData",{}).then(e=>{let t=e.data;new Vue({el:"#screenApp",data:function(){return{startCapture:!0,stream:null,chunks:[],mediaRecorder:null,recording:null,checkDisableIntervelId:0,list:[],times:0,interverlId:0,size:0}},computed:{list:function(){return this.list}},methods:{getMediaPlay:function(){return navigator.getDisplayMedia?navigator.getDisplayMedia({video:!0,audio:!0}):navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}):navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen"},audio:!0}):navigator.getUserMedia({video:{mandatory:{chromeMediaSource:"desktop"}},audio:!0})},startScreen:async function(){let t=this;this.startCapture=!1,this.checkDisableIntervelId=setInterval(function(){null==t.mediaRecorder?t.startCapture=!0:(clearInterval(t.checkDisableIntervelId),t.startCapture=!1)},500),this.recording&&window.URL.revokeObjectURL(this.recording),this.chunks=[],this.recording=null;try{this.stream=await this.getMediaPlay()}catch(e){console.log(e)}if(null==this.stream)return window.layer&&layer.msg("获取设备录制权限失败"),void window.Bus.$emit("changeScreenState",!1);this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:"video/webm"}),this.mediaRecorder.addEventListener("dataavailable",e=>{e.data&&0<e.data.size&&(t.size+=e.data.size,t.chunks.push(e.data))}),this.mediaRecorder.start(10),this.interverlId=setInterval(()=>{t.times+=1,window.Bus.$emit("changeScreenTimes",t.times)},1e3),window.layer&&layer.msg("开始录制，再次点击录制即可停止")},stopScreen:function(e){let t=!(this.startCapture=!0);try{this.mediaRecorder.stop()}catch(e){window.layer&&layer.msg("屏幕录制完毕! 检测到录制不完整，如需停止录制，请点击本页面的停止按钮来停止录制"),t=!0}this.stream.getTracks().forEach(e=>e.stop()),this.recording=window.URL.createObjectURL(new Blob(this.chunks,{type:"video/webm"})),clearInterval(this.interverlId),this.mediaRecorder=null,this.chunks=[],this.stream=null;var i={donwId:"d_"+parseInt(1e4*Math.random(1e4)),times:this.times,src:this.recording,size:this.size};this.times=0,this.size=0,window.Bus.$emit("changeScreenTimes",0),e(i),window.layer&&!t&&layer.msg("录制完成，请在接收文件列表查看")}},mounted:function(){window.Bus.$on("startScreen",this.startScreen),window.Bus.$on("stopScreen",this.stopScreen)}}),new Vue({el:"#fileApp",data:function(){let e=null;return io&&(e=io(t.wsHost)),{socket:e,config:t.rtcConfig,options:t.options,isJoined:!1,showReceiveFile:!1,showSendFile:!1,showReceiveTxt:!1,showLogs:!1,numSendFile:150,numReceiveFile:150,numReceiveTxt:150,numLogs:150,currentMenu:1,logsHeight:0,allManCount:0,isTxtMode:!1,txtEditId:0,isRealContentMode:!1,nickName:"",socketId:0,roomId:"10086",recoderId:0,rtcConns:{},remoteMap:{},chunkSize:262144,allSended:!1,currentReceiveSize:0,currentSendSize:0,currentChooseFile:null,chooseFileList:[],sendFileList:[],receiveFileList:[],receiveTxtList:[],chatingList:[],logs:[],isScreen:!1,screenTimes:0,switchData:{},token:"",manageIframeId:0}},computed:{createDisabled:function(){return this.isJoined||0<this.chooseFileList.length},exsitDisabled:function(){return!this.isJoined},uploadDisabled:function(){return 0==this.chooseFileList.length||this.allSended},showSendFileList:function(){return this.sendFileList&&5<this.sendFileList.length},noOthersInRoom:function(){return 0===Object.keys(this.remoteMap).length},isMobile:function(){return navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)}},watch:{allManCount:function(e,t){},currentMenu:function(e,t){},allSended:function(e,t){},currentReceiveSize:function(e,t){this.currentReceiveSize=e},remoteMap:{handler:function(e,t){},deep:!0,immediate:!0},receiveFileList:{handler:function(e,t){},deep:!0,immediate:!0},receiveTxtList:{handler:function(e,t){},deep:!0,immediate:!0},sendFileList:{handler:function(e,t){},deep:!0,immediate:!0},chatingList:{handler:function(e,t){},deep:!0,immediate:!0},chooseFileList:{handler:function(e,t){let n=this;this.socketId&&e.forEach(i=>{n.$refs.sendProgress.max+=i.size,n.allSended=!1;let e=[];for(var t in n.remoteMap)n.setRemoteInfo(t,{[i.index+"offset"]:0,[i.index+"status"]:0,[i.index+"file"]:i,[i.index+"reader"]:new FileReader}),e.push(t);let o="";0<e.length&&(o+="发送给房间的 "+e[0]+" ...等"+e.length+"人");for(let t in n.remoteMap)0<n.sendFileList.filter(e=>i.name===e.name&&i.size===e.size&&i.type===e.type&&i.id===t).length||n.sendFileList.push({index:i.index,id:t,name:i.name,size:i.size,type:i.type,process:0,done:!1,toIdStr:o,start:0,cost:0})})},deep:!0,immediate:!0}},methods:{startScreen:function(){if(this.isMobile)window.layer&&layer.msg("移动端暂不支持屏幕录制");else{if(this.isScreen)window.Bus.$emit("stopScreen",e=>{this.receiveFileList.push({id:"网页录屏",href:e.src,style:"color: #ff5722;text-decoration: underline;",name:"screen-recording-"+e.donwId+".mp4",type:"webm/mp4",size:e.size,process:100,done:!0,start:0,cost:e.times}),this.socket.emit("message",{emitType:"stopScreen",room:this.roomId,size:e.size,cost:e.times})});else{let t=this;window.layer&&layer.confirm("是否进行屏幕录制（全程本地进行，不会进过服务器）",e=>{window.Bus.$emit("startScreen"),t.socket.emit("message",{emitType:"startScreen",room:this.roomId})},e=>{this.isScreen=!this.isScreen,layer.close(e)})}this.isScreen=!this.isScreen}},shareUrl:function(){document.querySelector("#shareUrl").setAttribute("data-clipboard-text",window.location.href+"#r="+this.roomId),new ClipboardJS("#shareUrl").on("success",function(e){e.clearSelection(),window.layer&&layer.msg("复制房间链接成功!")})},copyTxt:function(e,t){document.querySelector("#"+e).setAttribute("data-clipboard-text",t),new ClipboardJS("#"+e).on("success",function(e){e.clearSelection(),window.layer&&layer.msg("复制内容成功!")})},handlerRoomHistory:function(){let t=this;var e=window.location.hash||"";e&&e.includes("#")&&((e=e.split("r="))&&1<e.length&&(this.roomId=(e[1]+"").replace(/\s*/g,"").substr(0,15),window.layer&&(layer.confirm("进入房间"+this.roomId,e=>{window.location.hash="",layer.close(e),t.createRoom()},e=>{t.roomId="",window.location.hash="",layer.close(e)}),this.addPopup("你通过分享加入了房间号为 "+this.roomId),this.logs.push("你通过分享加入了房间号为 "+this.roomId))))},chating:function(){let o=this;if(window.layer){let e={type:1,fixed:!1,maxmin:!1,area:["600px","600px"],title:"公共聊天频道",success:function(e,t){let i=null;1===o.currentMenu?i=o.$refs.btnHome:2===o.currentMenu?i=o.$refs.btnReceive:3===o.currentMenu&&(i=o.$refs.btnTxt),document.querySelector(".layui-layer-title").style.borderTopRightRadius="15px",document.querySelector(".layui-layer-title").style.borderTopLeftRadius="15px",document.querySelector(".layui-layer").style.borderRadius="15px",document.querySelector(".chating-content").style.backgroundColor=i.style.getPropertyValue("--bgColorBody"),document.querySelector(".layui-textarea").style.backgroundColor=i.style.getPropertyValue("--bgColorBody"),document.querySelector(".layui-layer-title").style.backgroundColor=i.style.getPropertyValue("--bgColorBody"),document.querySelector(".layui-layer").style.backgroundColor=i.style.getPropertyValue("--bgColorBody"),o.chatingTpl()},content:`
                            <div class="layui-col-sm12" style="padding: 15px;">
                                <div class="layui-card chating-content" id="chating_tpl_view" style="padding: 5px;"> </div>
                                <script id="chating_tpl" type="text/html">
                                    <div style="text-align: center; color: #ffe2bc; font-size: 12px;margin-top: -5px; margin-bottom: 20px;"> -------- 仅展示10条历史消息 -------- </div>
                                    {{#  layui.each(d, function(index, info){ }}
                                    <div style="margin-bottom: 30px;display: inline-flex;">
                                        <a > <img style="width: 32px; height: 32px;" src="f/image/44826979.png" alt="img"> </a>
                                        <div style="margin-left: 15px; margin-top: -5px;">
                                            <div style="word-break: break-all;"> <small>房间号: <b>{{info.room}}</b></small> - <small>用户: <b>{{info.socketId}}</b></small> - <small>时间: <b>{{info.time}}</b></small> </div>
                                            <div style="margin-top: 5px;word-break: break-all;">说: <b style="font-weight: bold; font-size: large;"> {{info.msg}} </b></div>
                                        </div>
                                    </div>
                                    {{#  }); }}
                                </script>
                            </div>
                            <div style="bottom: 0px; position: absolute; width: 100%; padding: 20px;">
                                <textarea style="border-radius: 15px;" maxlength="50000" id="blog_comment" class="layui-textarea" placeholder="文明发言，理性交流 ~"></textarea>
                                <button style="float: right;margin-top: 10px;" onclick="sendChating()" type="button" class="layui-btn layui-btn-normal layui-btn-sm">发言</button>
                            </div>
                        `};this.isMobile&&delete e.area;var t=layer.open(e);this.isMobile&&layer.full(t)}},escapeHtml:function(){var t={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"},unescape:{"&amp;":"&","&apos;":"'","&gt;":">","&lt;":"<","&quot;":'"'}},i={escape:RegExp("["+Object.keys(t.escape).join("")+"]","g"),unescape:RegExp("("+Object.keys(t.unescape).join("|")+")","g")};return{escape:function(e){return"string"!=typeof e?"":e.replace(i.escape,function(e){return t.escape[e]})},unescape:function(e){return"string"!=typeof e?"":e.replace(i.unescape,function(e){return t.unescape[e]})}}},chatingTpl:function(){var i=document.getElementById("chating_tpl"),o=document.getElementById("chating_tpl_view");if(i&&o){this.tpl(i,this.chatingList,o);let e=document.querySelector("#chating_tpl_view");o=e.clientHeight;let t=0;t=this.isMobile?document.documentElement.clientHeight-235:350,o>t?(e.style.height=t+"px",e.style.overflowY="scroll"):e.style.overflowY="none"}},tpl:function(e,t,i){window.laytpl&&laytpl(e.innerHTML).render(t,e=>{i.innerHTML=e})},sendChating:function(){var e=document.querySelector("#blog_comment").value;this.createDisabled?""!==e&&void 0!==e?1e3<e.length?window.layer&&layer.msg("内容太长啦，不能超过1000个字"):(this.socket.emit("chating",{recoderId:this.recoderId,msg:e,room:this.roomId,socketId:this.socketId,time:(new Date).toLocaleString()}),document.querySelector("#blog_comment").value=""):window.layer&&layer.msg("请先填写内容哦"):window.layer&&layer.msg("请先加入房间，才能发言哦")},sendBugs:function(){if(window.layer){let o=this;layer.prompt({formType:2,title:"请描述您需要反馈的问题"},function(e,t,i){o.socket.emit("message",{emitType:"sendBugs",msg:e,room:o.roomId}),layer.msg("问题反馈成功，更多问题可以加群交流，将更快解决"),layer.close(t)})}},refleshRoom:function(){this.createDisabled||(this.roomId=parseInt(1e5*Math.random()),this.addPopup("你刷新了房间号, 当前房间号为 "+this.roomId),this.logs.push("你刷新了房间号, 当前房间号为 "+this.roomId),$("#refresh").removeClass("layui-anim-rotate"),setTimeout(()=>{$("#refresh").addClass("layui-anim-rotate")},50))},manageChange:function(e){this.socket.emit("manageChange",{id:e.id,room:this.roomId,token:this.token,content:e.content})},manageReload:function(e){this.socket.emit("manageReload",{id:e.id,room:this.roomId,token:this.token,content:e.time})},genNickName:function(){return function(t){let i="";for(let e=0;e<t;e++){var o="";n=19968,s=40869,o=Math.floor(Math.random()*(n-s)+s).toString(16),i+=(o=(o="\\u"+(o=o)).replace(/\\/g,"%"),o=(o=unescape(o)).replace(/%/g,"\\"))}var n,s;return i}(4)},addPopup:function(e){window.Bus.$emit("addPopup",e)},cleanPopup:function(){window.Bus.$emit("popupMap")},clickChooseFile:function(){this.$refs["self-file"].click(),this.createDisabled||(this.addPopup("请先创建/加入房间后，再选择文件"),this.logs.push("请先创建/加入房间后，再选择文件")),this.noOthersInRoom&&(this.addPopup("请用户方都加入房间后，再选择文件"),this.logs.push("请用户方都加入房间后，再选择文件"))},sendTxt:function(){var e;this.createDisabled?this.noOthersInRoom?window.layer&&layer.msg("房间内至少需要两个人才能发送内容"):this.isRealContentMode?(e=layedit.getContent(this.txtEditId)).length<=0?window.layer&&layer.msg("请输入发送的富文本内容"):1e3<e.length?window.layer&&layer.msg("富文本文字内容过长，长度最多1w单词!"):(this.socket.emit("message",{emitType:"sendTxt",content:encodeURIComponent(e),room:this.roomId,from:this.socketId,recoderId:this.recoderId}),window.layer&&(window.layui&&window.layedit&&(this.txtEditId=window.layedit.build("txt",{tool:["strong","italic","underline","del","|","left","center","right","face"]})),this.sendFileList.push({id:"txt",name:e,size:e.length,type:"富文本内容",process:100,done:!0,toIdStr:"",start:0,cost:0}),layer.msg("富文本内容发送完毕"))):(e=layedit.getText(this.txtEditId)).length<=0?window.layer&&layer.msg("请输入发送的文本内容"):1e3<e.length?window.layer&&layer.msg("文字内容过长，最多1000单词!"):(this.socket.emit("message",{emitType:"sendTxt",content:encodeURIComponent(e),room:this.roomId,from:this.socketId,recoderId:this.recoderId}),window.layer&&(window.layui&&window.layedit&&(this.txtEditId=window.layedit.build("txt",{tool:["strong","italic","underline","del","|","left","center","right","face"]})),this.sendFileList.push({id:"txt",name:e,size:e.length,type:"文本内容",process:100,done:!0,toIdStr:"",start:0,cost:0}),layer.msg("内容发送完毕"))):window.layer&&layer.msg("请先加入房间，再发送内容")},clickHome:function(e=!0){this.currentMenu=1;let t=this.$refs.btnHome;document.querySelector("#iamtsm").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileListDisable").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileList").style.backgroundColor=t.style.getPropertyValue("--bgColorBody");var i=document.querySelector(".menuBorder");!function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(t.getBoundingClientRect(),i),e&&this.clickSendFile()},clickReceive:function(e=!0){this.currentMenu=2;let t=this.$refs.btnReceive;document.querySelector("#iamtsm").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileListDisable").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileList").style.backgroundColor=t.style.getPropertyValue("--bgColorBody");var i=document.querySelector(".menuBorder");!function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(t.getBoundingClientRect(),i),e&&this.clickReceiveFile()},clickTxt:function(e=!0){this.currentMenu=3;let t=this.$refs.btnTxt;document.querySelector("#iamtsm").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileListDisable").style.backgroundColor=t.style.getPropertyValue("--bgColorBody"),document.querySelector("#chooseFileList").style.backgroundColor=t.style.getPropertyValue("--bgColorBody");var i=document.querySelector(".menuBorder");!function(e,t){e=Math.floor(e.left-t.closest("menu").offsetLeft-(t.offsetWidth-e.width)/2)+"px";t.style.transform=`translate3d(${e}, 0 , 0)`}(t.getBoundingClientRect(),i),e&&this.clickReceiveTxt()},getFileSizeStr:function(e){let t=(e/1048576).toString();e=t.split(".")[0];let i="";return t.split(".")[1]&&(i=t.split(".")[1].substr(0,3)),e+"."+i+"M"},clickReceiveFile:function(){this.showReceiveFile=!this.showReceiveFile,this.showReceiveFile?this.numReceiveFile=50:this.numReceiveFile=150},clickReceiveTxt:function(e=!0){e&&(this.isTxtMode=!this.isTxtMode,window.layui&&window.layedit&&(this.txtEditId=window.layedit.build("txt",{tool:["strong","italic","underline","del","|","left","center","right","face"]}))),this.showReceiveTxt=!this.showReceiveTxt,this.showReceiveTxt?this.numReceiveTxt=50:this.numReceiveTxt=150},clickSendFile:function(){this.showSendFile=!this.showSendFile,this.showSendFile?this.numSendFile=50:this.numSendFile=150},clickLogs:function(){this.showLogs=!this.showLogs,this.showLogs?this.numLogs=50:this.numLogs=150},containChinese:function(e){return/[\u4E00-\u9FA5\uF900-\uFA2D]/.test(e)},containNumber:function(e){return/^[0-9]+.?[0-9]*$/.test(e)},containSymbol:function(e){return new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>《》/?~！@#￥……&*（）——|{}【】‘；：”“'。，、？]").test(e)},createRoom:function(){this.roomId=this.roomId.toString().replace(/\s*/g,""),null!==this.roomId&&void 0!==this.roomId&&""!==this.roomId?this.switchData.allowChinese||!this.containChinese(this.roomId)?this.switchData.allowNumber||!this.containNumber(this.roomId)?this.switchData.allowSymbol||!this.containSymbol(this.roomId)?0<this.chooseFileList.length?window.layer?layer.msg("请先加入房间再选文件"):alert("请先加入房间再选文件"):this.roomId&&(15<this.roomId.toString().length?window.layer?layer.msg("房间号太长啦"):alert("房间号太长啦"):(this.socket.emit("createAndJoin",{room:this.roomId}),this.isJoined=!0,this.addPopup("你进入了房间"+this.roomId),this.logs.push("你进入了房间"+this.roomId))):window.layer?layer.msg("房间号不允许特殊符号"):alert("房间号不允许特殊符号"):window.layer?layer.msg("房间号不允许数字"):alert("房间号不允许数字"):window.layer?layer.msg("房间号不允许中文"):alert("房间号不允许中文"):window.layer?layer.msg("请先填写房间号"):alert("请先填写房间号")},exitRoom:function(){for(var t in this.roomId&&this.socket.emit("exit",{from:this.socketId,room:this.roomId,recoderId:this.recoderId}),this.rtcConns){let e=this.rtcConns[t];e.close(),e=null}window.location.reload()},getRtcConnect:function(e){return this.rtcConns[e]},createRtcConnect:function(o){if(void 0!==o){let t=this,i=new RTCPeerConnection(this.config);return i.onicecandidate=e=>{t.iceCandidate(i,o,e)},this.rtcConns[o]=i,this.remoteMap[o]||Vue.set(this.remoteMap,o,{id:o}),this.initSendDataChannel(o),i.onremovestream=e=>{t.removeStream(i,o,e)},i}},getOrCreateRtcConnect:function(e){let t=this.getRtcConnect(e);return void 0===t&&(t=this.createRtcConnect(e)),t},initSendDataChannel:function(t){let i=this,e=this.rtcConns[t].createDataChannel("sendDataChannel");e.binaryType="arraybuffer",e.addEventListener("open",()=>{"open"===e.readyState&&i.logs.push("建立连接 : channel open")}),e.addEventListener("close",()=>{"close"===e.readyState&&i.logs.push("连接关闭 : channel close")}),e.addEventListener("error",e=>{i.handlerSendChannelError(e)}),this.rtcConns[t].addEventListener("datachannel",e=>{i.initReceiveDataChannel(e,t)}),this.setRemoteInfo(t,{sendChannel:e})},handlerSendChannelError:function(e){console.error(e.error),this.logs.push("连接断开 : "+e)},initSendFile:function(){this.changeSendFileNext(),this.sendFileToRemoteAll()},changeSendFileNext:async function(){var t=this;let i=null;for(let e=0;e<t.chooseFileList.length;e++){var o=t.chooseFileList[e];if(0===o.fileSendStatus){i=o;break}}t.currentChooseFile=i,null!==i&&(t.currentChooseFile.fileSendStatus=1,t.socket.emit("message",{emitType:"sendFileInfo",index:t.currentChooseFile.index,name:t.currentChooseFile.name,type:t.currentChooseFile.type,size:t.currentChooseFile.size,room:t.roomId,from:t.socketId,recoderId:t.recoderId}))},sendFileToRemoteAll:function(){let t=this;if(null===t.currentChooseFile)return t.chooseFileList=[],console.log("文件全部发送完毕"),t.addPopup("文件全部发送完毕"),void t.logs.push("文件全部发送完毕");var i=t.getSendFileNextRemote();if(""!==i){let e=t.remoteMap[i][t.currentChooseFile.index+"reader"];e.addEventListener("loadend",this.sendFileToRemote),e.addEventListener("error",e=>{t.logs.push("读取文件错误 : "+e)}),e.addEventListener("abort",e=>{t.logs.push("读取文件中断 : "+e)}),t.readSlice(0)}else setTimeout(()=>{this.changeSendFileNext(),this.sendFileToRemoteAll()},1e3)},sendFileToRemote:function(i){let o=this.getSendFileNextRemote();if(""!==o){this.setRemoteInfo(o,{[this.currentChooseFile.index+"status"]:1});let e=this.remoteMap[o],t=e.sendChannel;t&&"open"===t.readyState&&(0===e[this.currentChooseFile.index+"offset"]&&(this.addPopup("正在发送给"+o.substr(0,4)+",0%。"),this.logs.push("正在发送给"+o.substr(0,4)+",0%。"),this.updateSendFileProcess(o,{start:Date.now()})),t.send(i.target.result),e[this.currentChooseFile.index+"offset"]+=i.target.result.byteLength,this.currentSendSize+=i.target.result.byteLength,this.updateSendFileProcess(o,{process:parseInt(e[this.currentChooseFile.index+"offset"]/this.currentChooseFile.size*100)}),e[this.currentChooseFile.index+"offset"]===this.currentChooseFile.size&&(this.addPopup("正在发送给"+o.substr(0,4)+",100%。"),this.logs.push("正在发送给"+o.substr(0,4)+",100%。"),this.currentSendSize=0,this.socket.emit("message",{emitType:"sendDone",room:this.roomId,from:this.socketId,size:this.currentChooseFile.size,name:this.currentChooseFile.name,type:this.currentChooseFile.type,to:o}),this.updateSendFileProcess(o,{done:!0}),this.setRemoteInfo(o,{[this.currentChooseFile.index+"status"]:2})))}},getSendFileNextRemote:function(){let e="",t=!1;for(var i in this.remoteMap)1===(this.remoteMap[i][this.currentChooseFile.index+"status"]||0)&&(t=!0,e=i);if(!t)for(var o in this.remoteMap)0===(this.remoteMap[o][this.currentChooseFile.index+"status"]||0)&&(e=o);let n=!0;for(var s in this.remoteMap){s=this.remoteMap[s][this.currentChooseFile.index+"status"]||0;0!==s&&1!==s||(n=!1)}return n?(this.allSended=!0,this.currentChooseFile.fileSendStatus=2,""):e},readSlice:function(t){var i=this.getSendFileNextRemote();if(""!==i){i=this.remoteMap[i],t=this.currentChooseFile.slice(i[this.currentChooseFile.index+"offset"],t+this.chunkSize);let e=i[this.currentChooseFile.index+"reader"];e.readAsArrayBuffer(t)}},receivedAck:function(e,t,i){this.socket.emit("message",{emitType:"receivedAck",room:this.roomId,from:this.socketId,offset:t,chunkSize:this.chunkSize,name:i,to:e})},initReceiveDataChannel:function(t,i){if(i&&t&&this.getRemoteInfo(i)){let e=t.channel;e.binaryType="arraybuffer",e.onmessage=e=>{this.receiveData(e,i)},e.onopen=()=>{e.readyState},e.onclose=()=>{e.readyState},this.setRemoteInfo(i,{receiveChannel:e})}},receiveData:function(t,i){if(t&&i){var o=this.getRemoteInfo(i),n=o.receiveFiles;if(n){var s=n.name,r=n.size,n=n.type;let e=o.receiveBuffer||new Array;o=o.receivedSize||0;0===o&&this.updateReceiveProcess(i,{start:Date.now()}),e.push(t.data),o+=t.data.byteLength,this.$refs.receiveProgress.value=o,this.setRemoteInfo(i,{receiveBuffer:e,receivedSize:o}),this.currentReceiveSize+=t.data.byteLength,this.receivedAck(i,o,s),this.updateReceiveProcess(i,{process:parseInt(o/r*100)}),o===r&&(console.log(s+" 接收完毕"),this.logs.push("接收完毕..."),this.$refs.receiveProgress.value=0,this.addPopup("文件[ "+s+" ]接收完毕，可点击右下角查看。"),this.updateReceiveProcess(i,{style:"color: #ff5722;text-decoration: underline;",href:URL.createObjectURL(new Blob(e),{type:n}),done:!0}),this.setRemoteInfo(i,{receiveBuffer:new Array,receivedSize:0}),this.currentReceiveSize=0)}else setTimeout(()=>{this.receiveData(t,i)},500)}},closeDataChannels:function(){for(var i in this.remoteMap){var o=i.id;let e=i.sendChannel,t=i.receiveChannel;o&&e&&t&&(e.close(),t.close())}},setRemoteInfo(e,t){var i;e&&t&&((i=this.remoteMap[e])&&(Object.assign(i,t),Vue.set(this.remoteMap,e,i)))},updateReceiveProcess:function(t,i){for(let e=0;e<this.receiveFileList.length;e++){var o=this.receiveFileList[e];o.id!==t||o.done||(i.cost=parseInt((Date.now()-o.start)/1e3),Object.assign(this.receiveFileList[e],i))}},updateSendFileProcess:function(t,i){for(let e=0;e<this.sendFileList.length;e++){var o=this.sendFileList[e];o.id!==t||o.index!==this.currentChooseFile.index||o.done||(i.cost=parseInt((Date.now()-o.start)/1e3),Object.assign(this.sendFileList[e],i))}},getRemoteInfo(e){if(e)return this.remoteMap[e]},removeStream:function(e,t,i){this.getOrCreateRtcConnect(t).close,delete this.rtcConns[t],delete this.remoteMap[t]},iceCandidate:function(e,t,i){null!=i.candidate&&(i={from:this.socketId,to:t,room:this.roomId,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,sdp:i.candidate.candidate},this.socket.emit("candidate",i))},offerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("offer",i)},offerFailed:function(e,t,i){this.logs.push("offer失败,"+i)},answerSuccess:function(e,t,i){e.setLocalDescription(i).then(e=>{});i={from:this.socketId,to:t,room:this.roomId,sdp:i.sdp};this.socket.emit("answer",i)},answerFailed:function(e,t,i){this.logs.push("answer失败,"+i)},addIceCandidateSuccess:function(e){this.logs.push("addIceCandidateSuccess成功,"+e)},addIceCandidateFailed:function(e){this.logs.push("addIceCandidate失败,"+e)},socketListener:function(){let n=this;this.socket.emit("count",{}),this.socket.on("created",async function(o){n.logs.push("创建房间,"+JSON.stringify(o)),n.socketId=o.id,n.roomId=o.room,n.recoderId=o.recoderId;for(let e=0;e<o.peers.length;e++){let t=o.peers[e].id,i=n.getOrCreateRtcConnect(t);i.createOffer(n.options).then(e=>{n.offerSuccess(i,t,e)},e=>{n.offerFailed(i,t,e)})}n.touchResize()}),this.socket.on("joined",function(e){n.logs.push("加入房间,"+JSON.stringify(e)),n.recoderId=e.recoderId,n.getOrCreateRtcConnect(e.from),n.addPopup(e.id+"加入了房间。"),n.touchResize()}),this.socket.on("offer",function(t){n.logs.push("offer,"+JSON.stringify(t));let i=n.getOrCreateRtcConnect(t.from);var e={type:"offer",sdp:t.sdp};i.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{}),i.createAnswer(n.options).then(e=>{n.answerSuccess(i,t.from,e)}).catch(e=>{n.answerFailed(i,t.from,e)})}),this.socket.on("answer",function(e){n.logs.push("answer,"+JSON.stringify(e));let t=n.getOrCreateRtcConnect(e.from);e={type:"answer",sdp:e.sdp};t.setRemoteDescription(new RTCSessionDescription(e)).then(e=>{})}),this.socket.on("candidate",function(e){n.logs.push("candidate,"+JSON.stringify(e));let t=n.getOrCreateRtcConnect(e.from);e=new RTCIceCandidate({candidate:e.sdp,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex});t.addIceCandidate(e).then(e=>{n.addIceCandidateSuccess(e)}).catch(e=>{n.addIceCandidateFailed(e)})}),this.socket.on("exit",function(e){void 0!==n.rtcConns[e.from]&&(n.addPopup(e.from+"退出了房间。"),n.logs.push("退出房间,"+JSON.stringify(e)),n.getOrCreateRtcConnect(e.from).close,delete n.rtcConns[e.from],Vue.delete(n.remoteMap,e.from),n.touchResize())}),this.socket.on("sendFileInfo",function(e){var t=e.from;n.setRemoteInfo(t,{receiveFiles:e}),n.addPopup(e.from+"选择了文件 [ "+e.name+" ]，即将发送。"),n.logs.push(e.from+"选择了文件 [ "+e.name+" ]，即将发送。"),n.$refs.receiveProgress.max=e.size,n.receiveFileList.push({id:t,index:e.index,href:"",name:e.name,type:e.type,size:e.size,process:0,done:!1,start:0,cost:0})}),this.socket.on("receivedAck",function(e){e.to===n.socketId&&(e.offset<n.currentChooseFile.size&&n.readSlice(e.offset),e.offset===n.currentChooseFile.size&&n.sendFileToRemoteAll())}),this.socket.on("sendTxt",function(e){var t=e.from;n.addPopup(e.from+"发送了文字 [ "+e.content.substr(0,10)+" ]"),n.logs.push(e.from+"发送了文字 [ "+e.content.substr(0,10)+" ]"),n.receiveTxtList.push({id:t,content:decodeURIComponent(e.content),time:(new Date).toLocaleString(),c_id:"txt_"+n.receiveTxtList.length,process:0,done:!1,start:0,cost:0})}),this.socket.on("count",function(e){n.allManCount=e.mc}),this.socket.on("tips",function(e){window.layer&&layer.msg(e.msg)}),this.socket.on("commData",function(e){n.switchData=e.switchData,e.chatingData.forEach(e=>{n.chatingList.push(e)})}),this.socket.on("chating",function(e){n.logs.push(e.room+"频道的"+e.socketId+"发言: [ "+e.msg+" ]"),e.msg=n.escapeHtml().escape(e.msg),n.chatingList.push(e),n.chatingTpl()}),this.socket.on("manageCheck",function(e){window.layer&&layer.prompt({formType:1,title:"请输入"},function(e,t,i){n.socket.emit("manageConfirm",{room:n.roomId,value:e}),layer.close(t)})}),this.socket.on("manage",function(e){window.layer&&(e.socketId===n.socketId?(layer.closeAll(),n.token=e.token,layer.load(2,{time:1e3,shade:[.8,"#000000"],success:function(e){layer.setTop(e)}}),setTimeout(()=>{n.manageIframeId=layer.tab({area:["100%","100%"],shade:[.8,"#393D49"],tab:[{title:e.content[0].title,content:e.content[0].html},{title:e.content[1].title,content:e.content[1].html},{title:e.content[2].title,content:e.content[2].html}],cancel:function(e,t){n.manageIframeId=0}}),layer.full(n.manageIframeId)},500)):layer.msg("非法触发事件"))}),this.socket.on("close",function(e){e=e.msg||"";e&&window.layer.open({title:"网站自动通知-"+(new Date).toLocaleString(),content:e})})},initCss:function(e){e&&(1===this.currentMenu?this.clickHome(!1):2===this.currentMenu?this.clickReceive(!1):3===this.currentMenu&&this.clickTxt(!1),this.reCaculateSwiperSize(),window.layer&&0!==this.manageIframeId&&layer.full(this.manageIframeId),this.logsHeight=document.documentElement.clientHeight-55)},loadJS:function(e,t){var i=document.createElement("script"),o=t||function(){};i.type="text/javascript",i.readyState?i.onreadystatechange=function(){"loaded"!=i.readyState&&"complete"!=i.readyState||(i.onreadystatechange=null,o())}:i.onload=function(){o()},i.src=e,document.getElementsByTagName("head")[0].appendChild(i)},reCaculateSwiperSize:function(){var e,t=document.body.clientWidth;window.userListSwiper&&(e=parseInt(t/100)-1,window.userListSwiper.params.slidesPerView=e),window.fileListSwiper&&(t=parseInt(t/100)-1,window.fileListSwiper.params.slidesPerView=t)},touchResize:function(){let t=this;setTimeout(()=>{var e=new Event("resize");window.dispatchEvent(e),t.reCaculateSwiperSize()},100)},shaking:function(e,t,i){let o=["maringTop","marginLeft"],n=0;window.shakingId=setInterval(function(){document.getElementById(e).style[o[n%2]]=n++%4<2?t+"px":i+"px",15<n&&(clearInterval(window.shakingId),n=0)},32)}},created:function(){let o=this;window.location.hash&&window.location.hash.includes("debug")&&this.loadJS("/static/js/vconsole.min.js",function(){o.loadJS("/static/js/vconsole.js",function(){console.log("load vconsole success")})}),window.location.search&&window.location.search.includes("notice=iamtsm&msg=")&&setTimeout(()=>{var e=window.location.search.split("msg=")[1];o.socket.emit("close",{msg:decodeURIComponent(e)})},2e3),setTimeout(()=>{o.handlerRoomHistory(),o.socket.emit("getCommData",{}),window.upload&&upload.render({elem:"#chooseFileList",accept:"file",auto:!1,drag:!0,multiple:!0,choose:function(i){for(let t in i.pushFile()){var e=0<o.sendFileList.filter(e=>e.name===i.pushFile()[t].name&&e.size===i.pushFile()[t].size&&e.type===i.pushFile()[t].type).length;e&&window.layer&&layer.msg("已过滤发送过的文件"),e||o.chooseFileList.push(Object.assign(i.pushFile()[t],{index:"file"+t,fileSendStatus:0,offset:0}))}}})},2e3)},mounted:function(){this.$nextTick(()=>{this.logs.push("socket 初始化中..."),this.socketListener(),this.logs.push("socket 初始化成功")}),this.clickHome(!1),window.onresize=this.initCss,window.Bus.$on("changeScreenState",e=>{this.isScreen=e}),window.Bus.$on("changeScreenTimes",e=>{this.screenTimes=e}),window.Bus.$on("sendChating",e=>{this.sendChating()}),window.Bus.$on("manageChange",e=>{this.manageChange(e)}),window.Bus.$on("manageReload",e=>{this.manageReload(e)})},destroyed:function(){}}),window.manageReload=function(e){window.Bus.$emit("manageReload",e)},window.manageChange=function(e){window.Bus.$emit("manageChange",e)},window.sendChating=function(){window.Bus.$emit("sendChating",{})}})}},n.c=o,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s="../../res/js/index.js");function n(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return i[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}var i,o});